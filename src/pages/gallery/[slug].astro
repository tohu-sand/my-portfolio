---
import { getCollection, type CollectionEntry, render } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { entryToSlug } from "../../utils/slug";
import { compareByDateAsc, formatDateJP } from "../../utils/date";

type ArtworkEntry = CollectionEntry<"gallery">;

export async function getStaticPaths() {
  const artworks = await getCollection("gallery");
  return artworks.map((art: ArtworkEntry) => ({
    params: { slug: entryToSlug(art) },
    props: { entry: art },
  }));
}
export const prerender = true;

const { entry } = Astro.props as { entry: ArtworkEntry };
const { Content } = await render(entry);
const { data } = entry;
const slug = entryToSlug(entry);
const kind = data.kind ?? "illustration";
const imageUrl = data.image || data.thumbnail;
const mediumImageUrl = data.mediumImage || imageUrl;
const ogImage = data.mediumImage || data.image || data.thumbnail;
const dateStr = formatDateJP(data.date);
const readerBase = data.reader?.src ?? "";

const allArtworks = await getCollection("gallery");
const sortedArtworks = allArtworks.slice().sort(compareByDateAsc);

const currentIndex = sortedArtworks.findIndex(art => art.id === entry.id);
const prevArtwork = currentIndex < sortedArtworks.length - 1 ? sortedArtworks[currentIndex + 1] : null;
const nextArtwork = currentIndex > 0 ? sortedArtworks[currentIndex - 1] : null;

const defaultDescription = kind === "comic"
  ? `豆腐さんどの漫画「${data.title}」`
  : `豆腐さんどのイラスト作品「${data.title}」`;
const description = data.description || defaultDescription;
const artworkUrl = `https://tohu-sand.com/gallery/${slug}/`;

// 構造化データの準備
const structuredData = kind === "comic"
  ? {
      "@context": "https://schema.org",
      "@type": "CreativeWork",
      "name": data.title,
      "description": description,
      "url": artworkUrl,
      "thumbnailUrl": data.thumbnail,
      "dateCreated": data.date.toISOString().split("T")[0],
      "creditText": "豆腐さんど",
      "copyrightNotice": `© ${data.date.getFullYear()} 豆腐さんど`,
      "creator": {
        "@type": "Person",
        "name": "豆腐さんど",
        "url": "https://tohu-sand.com/"
      },
      "license": "https://tohu-sand.com/",
      "acquireLicensePage": "https://tohu-sand.com/contact/",
      "keywords": data.tags?.join(", ") || ""
    }
  : {
      "@context": "https://schema.org",
      "@type": "ImageObject",
      "name": data.title,
      "description": description,
      "url": imageUrl,
      "thumbnailUrl": data.thumbnail,
      "contentUrl": artworkUrl,
      "dateCreated": data.date.toISOString().split("T")[0],
      "creditText": "豆腐さんど",
      "copyrightNotice": `© ${data.date.getFullYear()} 豆腐さんど`,
      "creator": {
        "@type": "Person",
        "name": "豆腐さんど",
        "url": "https://tohu-sand.com/"
      },
      "license": "https://tohu-sand.com/",
      "acquireLicensePage": "https://tohu-sand.com/contact/",
      "keywords": data.tags?.join(", ") || ""
    };
---
<BaseLayout 
  title={`豆腐さんどのホームページ | ${data.title}`}
  description={description}
  ogTitle={data.title}
  ogDescription={description}
  ogUrl={artworkUrl}
  ogImage={ogImage}
  twitterCard="summary_large_image"
  twitterImageAlt={`${data.title} - 豆腐さんどの${kind === "comic" ? "漫画" : "イラスト"}作品`}
>
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)}></script>
  
  <article class="prose dark:prose-invert mx-auto prose-a:text-[color:var(--accent)] prose-a:hover:text-[color:var(--accent)]">
    <h1 class="text-3xl font-bold mb-4 text-stone-900 dark:text-stone-100">{data.title}</h1>
    {kind === "comic" ? (
      <>
        <div class="mb-6 not-prose md:hidden">
          <iframe
            src={`${readerBase}?layout=single`}
            title={data.reader?.title ?? "SkyBind reader"}
            loading="lazy"
            style="width: 100%; height: 70vh; min-height: 420px; border: 0;"
            allowfullscreen
          ></iframe>
        </div>
        <div class="mb-6 not-prose hidden md:block relative left-1/2 right-1/2 w-screen -ml-[50vw] -mr-[50vw] px-4 sm:px-6 lg:px-8">
          <div class="mx-auto w-full max-w-[50rem]">
            <iframe
              src={`${readerBase}?layout=spread`}
              title={data.reader?.title ?? "SkyBind reader"}
              loading="lazy"
              style="width: 100%; height: 70vh; min-height: 420px; border: 0;"
              allowfullscreen
            ></iframe>
          </div>
        </div>
      </>
    ) : (
      <div class="mb-6">
        <a href={imageUrl} target="_blank" rel="noopener noreferrer" class="block cursor-zoom-in">
          <img
            src={mediumImageUrl}
            alt={data.title}
            class="w-full rounded-lg hover:opacity-90 transition-opacity duration-200"
          />
        </a>
      </div>
    )}
    {data.description && (
    <p class="mb-4 text-stone-700 dark:text-stone-300">{data.description}</p>
    )}
    <Content />

    <p class="mt-8 text-sm text-stone-500 dark:text-stone-400">
      公開日:
  <time datetime={data.date.toISOString()}>{dateStr}</time>
      {data.tags && (
        <>
          &nbsp;|&nbsp;タグ:
          {data.tags.map((t: string) => (
            <span class="inline-block ml-1 px-2 py-0.5 bg-stone-200 dark:bg-stone-700 text-stone-800 dark:text-stone-200 rounded">{t}</span>
          ))}
        </>
      )}
    </p>

        <nav class="mt-12 pt-8 mb-5 border-t border-stone-200 dark:border-stone-700">
      <div class="flex justify-between items-center">
    {prevArtwork ? (
          <a 
      href={`/gallery/${entryToSlug(prevArtwork)}`}
            class="group flex items-center space-x-3 text-stone-600 dark:text-stone-400 hover:text-[color:var(--accent)] transition-colors"
          >
            <svg class="w-5 h-5 transform group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            <span class="text-sm">前の作品</span>
          </a>
        ) : (
          <div></div>
        )}

    {nextArtwork ? (
          <a 
      href={`/gallery/${entryToSlug(nextArtwork)}`}
            class="group flex items-center space-x-3 text-stone-600 dark:text-stone-400 hover:text-[color:var(--accent)] transition-colors"
          >
            <span class="text-sm">次の作品</span>
            <svg class="w-5 h-5 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </a>
        ) : (
          <div></div>
        )}
      </div>
    </nav>
  </article>
</BaseLayout>
